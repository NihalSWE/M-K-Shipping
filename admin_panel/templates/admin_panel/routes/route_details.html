{% extends 'admin_panel/base.html' %}
{% load static %}
{% load sass_tags %}

{% block css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'assets/css/select2_custom_style.css' %}">

<style>
    /* Global Overrides for this page only */
    body {
        background-color: #f1f5f9;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* --- Unique Card Styles --- */
    .route-card {
        background: #ffffff;
        border: 1px solid #ffffff;
        border-radius: 24px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        overflow: hidden;
        transition: box-shadow 0.3s ease;
    }
    
    .route-card:hover {
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    .card-header {
        background: transparent;
        padding: 24px 32px 10px;
        border: none;
    }

    .card-title {
        font-weight: 500;
        color: #1e293b;
        letter-spacing: -0.5px;
    }

    /* --- Sidebar Info Box --- */
    .route-info-box {
        background: linear-gradient(145deg, #f8fafc, #f1f5f9);
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 24px;
        position: relative;
        overflow: hidden;
    }

    .badge-start {
        background-color: #ecfdf5 !important; /* Soft Green */
        color: #047857 !important;
        border: 1px solid #a7f3d0 !important;
    }

    .badge-end {
        background-color: #fef2f2 !important; /* Soft Red */
        color: #b91c1c !important;
        border: 1px solid #fecaca !important;
    }

    /* --- Form Elements --- */
    .form-label {
        color: #64748b;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        margin-bottom: 8px;
    }

    .form-control-modern, .select2-container .select2-selection--single {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        height: 50px;
        transition: all 0.2s ease;
        font-size: 0.95rem;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.02);
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 48px;
        padding-left: 16px;
        color: #334155;
    }

    .form-control-modern:focus, .select2-container.select2-container--open .select2-selection--single {
        background-color: #fff;
        border-color: #6366f1;
        box-shadow: 0 0 0 4px #e0e7ff;
    }

    /* --- BUTTONS (Renamed & Hardcoded Colors) --- */
    
    /* 1. Main Action Button (Indigo) */
    .rc-btn-primary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 50px;
        border-radius: 12px;
        background-color: #6366f1 !important; /* Force Indigo */
        color: #ffffff !important; /* Force White Text */
        font-weight: 600;
        border: 1px solid transparent;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.4);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .rc-btn-primary:hover {
        background-color: #4f46e5 !important;
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.5);
        color: #ffffff !important;
    }

    .rc-btn-primary:active {
        transform: translateY(0);
    }

    /* 2. Modal Cancel Button (Light Gray) */
    .rc-btn-cancel {
        background-color: #f1f5f9 !important;
        color: #64748b !important;
        border: 1px solid #e2e8f0;
        height: 46px;
        width: 100%;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .rc-btn-cancel:hover {
        background-color: #e2e8f0 !important;
        color: #334155 !important;
    }

    /* 3. Modal Delete Button (Red) */
    .rc-btn-danger {
        background-color: #ef4444 !important;
        color: #ffffff !important;
        border: 1px solid transparent;
        height: 46px;
        width: 100%;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .rc-btn-danger:hover {
        background-color: #dc2626 !important;
        box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.4);
        transform: translateY(-1px);
        color: #ffffff !important;
    }

    /* --- Timeline Core --- */
    .timeline-wrapper {
        position: relative;
        padding: 20px 0;
    }

    .timeline-line {
        position: absolute;
        left: 32px;
        top: 40px;
        bottom: 40px;
        width: 3px;
        background: #e2e8f0;
        z-index: 0;
    }

    /* --- Timeline Item --- */
    .timeline-item {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 20px 24px;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), border-color 0.2s;
        cursor: default;
    }

    .timeline-item:not(.sortable-drag):hover {
        border-color: #cbd5e1;
        transform: translateX(4px);
    }

    .timeline-item.is-source {
        background: #f0fdf4;
        border-color: #bbf7d0;
    }
    .timeline-item.is-dest {
        background: #fef2f2;
        border-color: #fecaca;
    }

    /* --- Timeline Dots --- */
    .timeline-dot {
        position: absolute;
        left: -48px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #fff;
        border: 3px solid #6366f1; /* Indigo */
        color: #6366f1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 14px;
        z-index: 2;
        box-shadow: 0 0 0 6px #f1f5f9;
    }

    .timeline-item.is-source .timeline-dot {
        border-color: rgb(16 185 129 / 22%);
        background: rgb(16 185 129 / 42%);
        color: white;
    }
    .timeline-item.is-dest .timeline-dot {
        border-color: rgb(239 68 68 / 21%);
        background: rgb(239 68 68 / 35%);
        color: white;
    }

    /* --- Drag & Drop --- */
    .drag-handle {
        cursor: grab;
        color: #94a3b8;
        padding: 10px;
        border-radius: 8px;
        transition: all 0.2s;
    }
    .drag-handle:hover { background: #f1f5f9; color: #475569; }

    .sortable-drag {
        background: white;
        opacity: 1 !important;
        cursor: grabbing;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        transform: scale(1.02) !important;
        border: 1px solid #6366f1;
        z-index: 9999;
    }

    .sortable-ghost {
        background: #f1f5f9;
        border: 2px dashed #cbd5e1;
        opacity: 0.6;
        color: transparent;
    }
    .sortable-ghost * { opacity: 0; }

    /* --- Typography --- */
    .item-title { font-weight: 500; color: #1e293b; margin: 0; font-size: 1.05rem; }
    .item-meta { color: #64748b; font-size: 0.85rem; font-weight: 500; margin-top: 4px; }

    /* --- Animations --- */
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .timeline-item { animation: slideIn 0.4s ease forwards; }
    .timeline-item:nth-child(1) { animation-delay: 0.05s; }
    .timeline-item:nth-child(2) { animation-delay: 0.1s; }
    .timeline-item:nth-child(3) { animation-delay: 0.15s; }
    .timeline-item:nth-child(4) { animation-delay: 0.2s; }
    .timeline-item:nth-child(5) { animation-delay: 0.25s; }

    /* --- Messages --- */
    .error-success-div {
        border-radius: 12px;
        font-weight: 500;
        padding: 0;
        margin: 0;
        height: 0;
        overflow: hidden;
        transition: all 0.4s ease;
    }
    .error-success-div.show { padding: 16px; margin-top: 20px; height: auto; }
    .success-message { background: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
    .error-message { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }

    /* --- Updated Modal --- */
    .modal-content-modern {
        border: none;
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        background: #ffffff;
    }

    .rc-modal-icon {
        width: 72px;
        height: 72px;
        margin: 0 auto;
        border-radius: 50%;
        background-color: #fef2f2;
        color: #dc2626;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 24px;
        border: 4px solid #fef2f2;
        box-shadow: 0 0 0 4px #fff;
    }

    /* --- Modern Spinner Overlay Starts --- */
    .card-loader-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(2px);
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
        z-index: 1000;
        border-radius: 15px; /* Matches your card radius */
    }

    .modern-spinner {
        width: 45px;
        height: 45px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #4a3dd9; /* Your theme primary color */
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* --- Sleek Toast Notification --- */
    #custom-toast {
        position: fixed;
        top: 25px;
        right: 25px;
        /* Reduced opacity background with Glassmorphism */
        background: rgba(16, 207, 16, 0.85); 
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        
        color: white;
        padding: 14px 28px;
        border-radius: 50px;
        
        /* Glowing Effect: Layered shadows for depth and neon glow */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 
                    0 0 20px rgba(16, 207, 16, 0.4), 
                    inset 0 0 10px rgba(255, 255, 255, 0.2);
        
        border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle highlight border */
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 9999;
        font-weight: 500;
        letter-spacing: 0.5px;
        
        transform: translateX(150%);
        transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    #custom-toast.show {
        transform: translateX(0);
    }
    /* --- Modern Spinner Overlay Ends --- */

    /* --- Pricing Button Styles Starts --- */
    .btn-price-action {
        background-color: #f1f5f9 !important; /* Light Gray - Visible against white */
        color: #334155 !important;            /* Dark Text */
        border: 1px solid #cbd5e1;
        width: 100%;
        height: 50px; /* Same height as your other buttons */
        border-radius: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 24px; 
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-price-action:hover {
        background-color: #e2e8f0 !important; /* Darker gray on hover */
        transform: translateY(-2px);
    }

    /* The Warning/Flashing State */
    .price-alert-active {
        background-color: #fef2f2 !important; /* Red Background */
        border-color: #ef4444 !important;     /* Red Border */
        color: #dc2626 !important;            /* Red Text */
        animation: pulse-red 2s infinite;
    }

    @keyframes pulse-red {
        0% {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
        }
    }
    /* --- Pricing Button Styles Ends --- */

    /* Force the modal to be a Right-Side Drawer Starts */
    .vpx-drawer {
        position: fixed !important;
        top: 0;
        right: -100%; /* Default hidden state for mobile */
        width: 100%;  /* Full width on mobile */
        max-width: 850px; /* Locked at 850px on desktop */
        height: 100vh;
        background: #ffffff;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        transition: right 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        box-shadow: -15px 0 50px rgba(0, 0, 0, 0.2);
    }

    /* Adjust hiding position for larger screens to match max-width */
    @media (min-width: 850px) {
        .vpx-drawer {
            right: -850px;
        }
    }

    .vpx-drawer.active { 
        right: 0 !important; 
    }

    /* Modern Overlay - Click to close handled by your JS */
    .vpx-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(3px);
        z-index: 9998;
        display: none;
    }
    .vpx-overlay.active { display: block; }

    /* 2. HEADER */
    .vpx-header {
        padding: 1rem 1.5rem; /* Slightly tighter for mobile */
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    @media (min-width: 600px) {
        .vpx-header { padding: 1rem 2rem; }
    }

    /* 3. SCROLLABLE BODY */
    .vpx-body {
        flex: 1;
        overflow-y: auto;
        padding: 1rem 1.25rem;
        background-color: #f8fafc;
    }
    
    @media (min-width: 600px) {
        .vpx-body { padding: 1.5rem 2rem; }
    }

    /* 4. SEGMENT CARDS */
    .vpx-segment-card {
        background: #ffffff;
        border-radius: 12px;
        margin-bottom: 1.25rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        overflow: hidden; 
        transition: transform 0.2s ease;
    }

    .vpx-segment-header {
        padding: 12px 20px;
        background: rgba(79, 70, 229, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }

    .vpx-segment-header:hover {
        background: rgba(79, 70, 229, 0.08);
    }

    .vpx-segment-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #4338ca;
    }

    /* 5. RESPONSIVE GRID - 1 col (Mobile), 2 col (Tablet), 4 col (Desktop) */
    .vpx-grid {
        display: grid;
        grid-template-columns: 1fr; 
        gap: 1.25rem;
        padding: 1.25rem;
        background: #ffffff;
    }

    @media (min-width: 500px) {
        .vpx-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (min-width: 800px) {
        .vpx-grid { grid-template-columns: repeat(4, 1fr); }
    }

    .vpx-field label {
        font-size: 13px;
        font-weight: 500;
        color: #64748b;
        margin-bottom: 6px;
        display: block;
    }

    .vpx-input-container {
        display: flex;
        align-items: center;
        background: #ffffff;
        border: 1.5px solid #e2e8f0;
        border-radius: 8px;
        height: 38px;
        transition: all 0.2s ease;
    }

    .vpx-input-container:focus-within {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .vpx-currency {
        padding: 0 10px;
        color: #94a3b8;
        font-size: 0.85rem;
        border-right: 1px solid #f1f5f9;
    }

    .vpx-input {
        border: none !important;
        outline: none !important;
        width: 100%;
        padding: 0 10px;
        font-size: 0.95rem;
        color: #1e293b;
    }

    /* 6. COLLAPSE TRANSITION */
    .vpx-content {
        max-height: 1000px;
        transition: max-height 0.4s ease-in-out;
        overflow: hidden;
    }
    .vpx-segment-card.collapsed .vpx-content {
        max-height: 0;
    }
    .vpx-segment-card.collapsed .vpx-chevron {
        transform: rotate(-90deg);
    }

    /* 7. FOOTER & BUTTON */
    .vpx-footer {
        padding: 1.25rem 1.5rem;
        background: #ffffff;
        border-top: 1px solid #e2e8f0;
    }

    @media (min-width: 600px) {
        .vpx-footer { padding: 1.25rem 2rem; }
    }

    .vpx-btn-save {
        background: #3f4095;
        color: white;
        border: none;
        padding: 14px;
        border-radius: 10px;
        font-weight: 600;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(63, 64, 149, 0.2);
    }

    .vpx-btn-save:hover {
        background: #313280;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(63, 64, 149, 0.3);
    }

    /* Attention Pulse for Unset Prices */
    @keyframes vpx-pulse-glow {
        0% { border-color: #e2e8f0; box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        50% { border-color: #f59e0b; box-shadow: 0 0 8px rgba(245, 158, 11, 0.3); background: rgba(245, 158, 11, 0.02); }
        100% { border-color: #e2e8f0; box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
    }

    .vpx-needs-attention {
        animation: vpx-pulse-glow 2s infinite ease-in-out;
        border-width: 1.5px !important;
    }

    /* Red indicator dot for the segment header */
    .vpx-dot {
        height: 8px;
        width: 8px;
        background-color: #f59e0b;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    /* Force the modal to be a Right-Side Drawer Ends */
</style>
{% endblock css %}

{% block content %}

<div class="container-fluid py-5">
    <div class="row g-4 justify-content-center">

        <div class="col-xl-3 col-lg-4">
            <div class="card card-modern h-100 sticky-top" style="top: 100px; z-index: 10;">
                <div class="card-header pb-0">
                    <h5 class="card-title">Route Controller</h5>
                </div>
                <div class="card-body" id="routeControllerBody">
                    
                    <div class="route-info-box mb-4">
                        <div class="text-center">
                            <h3 class="mb-2 text-dark">{{ route.name }}</h3>
                            
                            <div class="d-flex align-items-center justify-content-center gap-2 mt-3">
                                <span class="badge badge-start shadow-sm px-3 py-2 rounded-pill">
                                    <i class="fa-solid fa-location-dot me-1"></i>
                                    {{ route.source.name }}
                                </span>

                                <i class="fa-solid fa-arrow-right text-muted mx-1" style="opacity: 0.5;"></i>

                                <span class="badge badge-end shadow-sm px-3 py-2 rounded-pill">
                                    <i class="fa-solid fa-flag-checkered me-1"></i>
                                    {{ route.destination.name }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <button id="btnSetPrices" 
                            type="button"
                            onclick="openVpxDrawer()"
                            class="btn btn-price-action {% if has_unset_prices %}price-alert-active{% endif %}">
                        <i class="fa-solid fa-tags"></i>
                        <span id="priceBtnText"> {% if has_unset_prices %} 
                                ⚠ Update Prices Needed 
                            {% else %} 
                                Manage Prices 
                            {% endif %}
                        </span>
                    </button>

                    <form id="addStopForm" class="theme-form mt-4">
                        <div class="mb-4">
                            <label class="form-label">Select Location</label>
                            <select class="form-select select2" id="new_stop" style="width: 100%;">
                                <option value="">Search stops...</option>
                                {% for loc in locations %}
                                <option value="{{ loc.id }}">{{ loc.name }} ({{ loc.code }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Time Offset (Mins)</label>
                            <input type="number" class="form-control form-control-modern" id="time_offset"
                                placeholder="e.g. 45">
                        </div>
                        <button class="btn rc-btn-primary w-100" type="submit">
                            <i class="fa-solid fa-plus me-2"></i> Add Stop
                        </button>
                    </form>

                    <div class="error-success-div"></div>
                </div>
            </div>
        </div>

        <div class="col-xl-8 col-lg-8">
            <div class="card card-modern h-100 position-relative">
                <div id="reorder-loader" class="card-loader-overlay">
                    <div class="modern-spinner"></div>
                </div>

                <div class="d-flex justify-content-between align-items-center bg-white border-bottom-0 pt-4">
                    </div>

                <div class="px-4 px-md-5">
                </div>
                <div class="card-header d-flex justify-content-between align-items-center bg-white border-bottom-0 pt-4">
                    <div>
                        <h4 class="card-title mb-1">Journey Sequence</h4>
                        <p class="text-muted small mb-0">Drag items to reorder the stops.</p>
                    </div>
                    <button class="btn btn-light text-dark btn-sm rounded-pill px-4 fw-bold shadow-sm border"
                        onclick="location.reload()">
                        <i class="fa-solid fa-rotate-right me-2"></i> Refresh
                    </button>
                </div>

                <div class="card-body px-4 px-md-5">
                    <div class="timeline-wrapper ms-4"> <div class="timeline-line"></div>
                        
                        <div id="timelineList" class="w-100 position-relative">
                            {% for stop in stops %}
                            <div class="timeline-item 
                                {% if stop.location.id == route.source.id %}is-source locked-route-stop{% endif %} 
                                {% if stop.location.id == route.destination.id %}is-dest locked-route-stop{% endif %}"
                                data-id="{{ stop.id }}">

                                <div class="timeline-dot">
                                    {% if stop.location.id == route.source.id %}
                                    <i class="fa-solid fa-play" style="font-size: 10px;"></i>
                                    {% elif stop.location.id == route.destination.id %}
                                    <i class="fa-solid fa-flag-checkered" style="font-size: 10px;"></i>
                                    {% else %}
                                    <span class="stop-index">{{ forloop.counter0 }}</span>
                                    {% endif %}
                                </div>

                                <div class="flex-grow-1 ps-2 pe-3" style="min-width: 0;">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <h5 class="item-title text-truncate" title="{{ stop.location.name }}">
                                            {{ stop.location.name }}
                                        </h5>
                                    </div>
                                    <div class="d-flex align-items-center gap-3 item-meta">
                                        {% if stop.location.district.name != stop.location.name %}
                                            <span><i class="fa-solid fa-map-pin me-1"></i> {{ stop.location.district.name }}</span>
                                        {% endif %}

                                        {% if stop.location.id == route.source.id %}
                                            <span class="badge bg-light text-dark border rounded-pill fw-normal px-2">
                                                <i class="fa-solid fa-play me-1"></i> Start
                                            </span>
                                        {% elif stop.location.id == route.destination.id %}
                                            <span class="badge bg-light text-dark border rounded-pill fw-normal px-2">
                                                <i class="fa-solid fa-flag-checkered me-1"></i> End
                                            </span>
                                        {% else %}
                                            <span class="badge bg-light text-secondary border rounded-pill fw-normal px-2">
                                                <i class="fa-regular fa-clock me-1"></i> +{{ stop.time_offset_minutes }}m
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="d-flex align-items-center">
                                    {% if stop.location.id != route.source.id and stop.location.id != route.destination.id %}
                                        <button class="btn btn-light text-danger btn-sm rounded-circle p-2 delete-stop me-2 border-0" 
                                            style="width: 36px; height: 36px; transition: 0.2s;"
                                            data-id="{{ stop.id }}" title="Delete Stop">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                        <div class="drag-handle" title="Drag to reorder">
                                            <i class="fa-solid fa-grip-vertical fa-lg"></i>
                                        </div>
                                    {% else %}
                                        <div class="text-muted opacity-50 pe-2" title="Fixed Point">
                                            <i class="fa-solid fa-lock"></i>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content modal-content-modern">
            <div class="modal-body text-center p-4">
                
                <div class="rc-modal-icon">
                    <i class="fa-regular fa-trash-can fa-2x"></i>
                </div>

                <h5 class="fw-bold mb-2" style="color: #1e293b;">Delete Stop?</h5>
                <p class="text-muted small mb-4 ms-2 me-2">
                    Are you sure you want to remove this stop?
                </p>

                <div class="row g-2">
                    <div class="col-6">
                        <button class="btn rc-btn-cancel" data-bs-dismiss="modal">
                            Cancel
                        </button>
                    </div>
                    <div class="col-6">
                        <button id="confirmDelete" class="btn rc-btn-danger">
                            Delete
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


<!-- Pricing Matrix Drawer Starts -->
<div class="vpx-overlay" id="vpxOverlay" onclick="closeVpxDrawer()"></div>

<div class="vpx-drawer" id="vpxDrawer">
    <div class="vpx-header">
        <span class="vpx-header-title">Price Management Matrix</span>
        <button type="button" class="btn-close" onclick="closeVpxDrawer()"></button>
    </div>

    <div class="vpx-body">
        <form id="vpxForm">
            {% for label, segment_data in price_matrix.items %}
                <div class="vpx-segment-card" id="card-{{ forloop.counter }}">
                    <div class="vpx-segment-header" onclick="toggleSegment('card-{{ forloop.counter }}')">
                        <span>
                            {% if segment_data.needs_attention %}
                                <span class="vpx-dot"></span> {% endif %}
                            <span class="vpx-segment-title">{{ label }}</span>
                        </span>
                        <i class="fa-solid fa-chevron-down vpx-chevron"></i>
                    </div>
                    
                    <div class="vpx-content">
                        <div class="vpx-grid">
                            {% for p in segment_data.prices %}
                                {% if p.seat_category.is_bookable %}
                                <div class="vpx-field">
                                    <label>{{ p.seat_category.name }}</label>
                                    <div class="vpx-input-container {% if p.price <= 0 %}vpx-needs-attention{% endif %}">
                                        <span class="vpx-currency">৳</span>
                                        <input type="number" 
                                            class="vpx-input price-input" 
                                            data-id="{{ p.id }}" 
                                            value="{{ p.price }}"
                                            oninput="removePulse(this)"
                                            step="0.01">
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </form>
    </div>

    <div class="vpx-footer">
        <button type="button" class="vpx-btn-save" id="savePricingBtn" onclick="savePrices()">
            <i class="fa-solid fa-floppy-disk"></i>
            <span>Apply Pricing Updates</span>
        </button>
    </div>
</div>
<!-- Pricing Matrix Drawer Ends -->

<div id="custom-toast">
    <i class="fa-solid fa-circle-check"></i>
    <span id="toast-message">Sequence updated!</span>
</div>
{% endblock %}

{% block scriptcontent %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
    // Function to trigger the glowing state
    function triggerPriceAlert() {
        console.log("Triggering Price Alert..."); // Check your console for this
        const btn = document.getElementById('btnSetPrices');
        const txt = document.getElementById('priceBtnText');
        
        if(btn) {
            btn.classList.add('price-alert-active');
            if(txt) txt.innerHTML = '⚠ Update Prices Needed'; 
        } else {
            console.error("Button ID 'btnSetPrices' not found!");
        }
    }


    $(document).ready(function () {
        $('#new_stop').select2({
            placeholder: "Select Location",
            width: '100%',
            dropdownParent: $('#routeControllerBody')
        });
    });

    // Elements for Loader and Toast
    const loader = document.getElementById('reorder-loader');
    const toast = document.getElementById('custom-toast');


    function showToast(message) {
        $("#toast-message").text(message);
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function showMessage(type, message) {
        const div = $(".error-success-div");
        div.removeClass("error-message success-message").addClass(type + "-message").text(message);
        div.addClass("show");
        setTimeout(() => div.removeClass("show"), 3000);
        if (type === "success") { setTimeout(() => location.reload(), 1000); }
    }

    // Price Segment Drawer Functions Starts
    function openVpxDrawer() {
        const drawer = document.getElementById('vpxDrawer');
        const overlay = document.getElementById('vpxOverlay');
        if (drawer && overlay) {
            drawer.classList.add('active');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeVpxDrawer() {
        const drawer = document.getElementById('vpxDrawer');
        const overlay = document.getElementById('vpxOverlay');
        if (drawer && overlay) {
            drawer.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    }

    function toggleSegment(cardId) {
        const card = document.getElementById(cardId);
        if (card) card.classList.toggle('collapsed');
    }

    function removePulse(input) {
        const container = input.closest('.vpx-input-container');
        if (input.value > 0) {
            container.classList.remove('vpx-needs-attention');
        } else {
            container.classList.add('vpx-needs-attention');
        }
    }

    function savePrices() {
        const btn = document.getElementById('savePricingBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

        const updates = Array.from(document.querySelectorAll('.price-input')).map(input => ({
            id: input.getAttribute('data-id'),
            price: input.value || 0
        }));

        fetch(window.location.href, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json", 
                "X-CSRFToken": "{{ csrf_token }}" 
            },
            body: JSON.stringify({ action: "save_prices", prices: updates })
        })
        .then(r => r.json())
        .then(data => {
            if(data.status === 'success') {
                btn.style.background = '#10b981';
                btn.innerHTML = 'Saved!';
                setTimeout(() => { location.reload(); }, 600);
            } else {
                alert("Error: " + data.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
    }
    // Price Segment Drawer Functions Ends

    // --- SORTABLE JS ---
    const list = document.getElementById('timelineList');
    if (list) {
        const updateIndices = () => {
            const items = list.querySelectorAll('.timeline-item');
            items.forEach((item, index) => {
                const indexSpan = item.querySelector('.stop-index');
                if (indexSpan) {
                    indexSpan.textContent = index;
                }
            });
        };

        new Sortable(list, {
            animation: 300,
            easing: "cubic-bezier(1, 0, 0, 1)",
            handle: '.drag-handle',
            
            // This prevents the locked items from being dragged
            filter: '.locked-route-stop', 
            
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-drag',

            // --- IMPROVED LOGIC ---
            // Prevent dropping items OUTSIDE the bounds of Start/End.
            // If the user tries to drag an item above Start or below End, this returns false.
            onMove: function (evt) {
                // Return false if the target (related) is locked. 
                // This creates a physical wall at the top and bottom.
                return !evt.related.classList.contains('locked-route-stop');
            },

            onEnd: function (evt) {
                // If the user didn't actually change the order, do nothing
                if (evt.oldIndex === evt.newIndex) return;

                updateIndices();

                // Show Loader
                if(loader) loader.style.display = 'flex';

                const orderedIds = Array.from(list.children).map(item => item.dataset.id);

                fetch(window.location.href, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json", 
                        "X-CSRFToken": "{{ csrf_token }}" // Ensure this token is rendering correctly
                    },
                    body: JSON.stringify({ action: "reorder_stops", ordered_ids: orderedIds })
                })
                .then(r => r.json())
                .then(d => {
                    if(loader) loader.style.display = 'none';

                    if (d.status === 'success') {
                        const btn = document.getElementById('btnSetPrices');
                        if (btn) {
                            // 1. Add the flashing class
                            btn.classList.add('price-alert-active');
                            
                            // 2. Update the text manually since the template can't do it dynamically
                            const span = btn.querySelector('span');
                            if (span) {
                                span.innerHTML = '⚠ Update Prices Needed';
                            }
                        }
                        // Optional: Show a small toast notification here
                        showToast("Route sequence updated!");
                        triggerPriceAlert();
                        location.reload();
                    } else {
                        alert(d.message);
                        location.reload(); // Reset UI on error
                    }
                })
                .catch(err => console.error("Drag Error:", err));
            }
        });
    }

    // --- ADD STOP ---
    $("#addStopForm").on("submit", e => {
        e.preventDefault();
        fetch(window.location.href, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
            body: JSON.stringify({
                action: "add_stop",
                location_id: $("#new_stop").val(),
                time_offset: $("#time_offset").val()
            })
        })
            .then(r => r.json())
            .then(d => {
                showMessage(d.status, d.message);
                if(d.status === 'success') {
                    // *** FORCE FLASH HERE ***
                    triggerPriceAlert();
                    // Delay reload so you can see the button flash
                    setTimeout(() => location.reload(), 2000); 
                }
            })
            .catch(err => console.error("Add Error:", err));
    });

    // --- DELETE STOP ---
    let deleteId = null;
    $(document).on("click", ".delete-stop", function () {
        deleteId = this.dataset.id;
        $("#deleteModal").modal('show');
    });

    $("#confirmDelete").on("click", function () {
        fetch(window.location.href, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
            body: JSON.stringify({ action: "delete_stop", id: deleteId })
        })
            .then(r => r.json())
            .then(d => {
                $("#deleteModal").modal('hide');
                showMessage(d.status, d.message);
                if(d.status === 'success') {
                    // *** FORCE FLASH HERE ***
                    triggerPriceAlert();
                }
            })
            .catch(err => console.error("Delete Error:", err));
    });

</script>
{% endblock %}